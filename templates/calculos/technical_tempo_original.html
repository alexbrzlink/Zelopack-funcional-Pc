{% extends 'base.html' %}

{% block title %}Cálculos Técnicos Avançados - Zelopack{% endblock %}

{% block styles %}
<style>
    .card-calc {
        transition: all 0.3s ease;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .card-calc:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid #007bff;
        font-weight: 600;
    }
    
    .nav-tabs .nav-link.active {
        font-weight: bold;
        border-top: 3px solid #007bff;
    }
    
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    
    .btn-calculate {
        background-color: #007bff;
        color: white;
        font-weight: 600;
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-calculate:hover {
        background-color: #0069d9;
        transform: translateY(-2px);
    }
    
    .result-box {
        background-color: #f8f9fa;
        border-left: 4px solid #28a745;
        padding: 15px;
        margin-top: 20px;
        border-radius: 4px;
    }
    
    .result-item {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    
    .result-item:last-child {
        border-bottom: none;
    }
    
    .result-value {
        font-weight: bold;
        color: #28a745;
    }
    
    .input-with-unit {
        position: relative;
    }
    
    .input-unit {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-size: 14px;
    }
    
    .tab-pane {
        padding: 20px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .calculation-group {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .form-label {
        font-weight: 500;
        margin-bottom: 5px;
    }
    
    .formula-box {
        background-color: #f0f5ff;
        border-radius: 4px;
        padding: 10px 15px;
        margin-bottom: 15px;
        font-family: "Courier New", monospace;
    }
    
    .formula-title {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 5px;
        color: #0D47A1;
    }
    
    .search-box {
        margin-bottom: 20px;
    }
    
    .calculation-icons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .calc-icon {
        display: flex;
        align-items: center;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 6px 10px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .calc-icon:hover {
        background-color: #e9ecef;
        border-color: #adb5bd;
    }
    
    .calc-icon i {
        margin-right: 6px;
        color: #007bff;
    }
    
    .calc-icon.active {
        background-color: #e7f1ff;
        border-color: #007bff;
        font-weight: 500;
    }
    
    #calculatorContainer {
        margin-top: 20px;
    }
    
    .calculator-header {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #f0f0f0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-3"><i class="fas fa-calculator"></i> Cálculos Técnicos Avançados</h2>
    
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="d-flex align-items-center">
                <div class="input-group">
                    <span class="input-group-text bg-light">
                        <i class="fas fa-calculator me-2"></i>
                        Calculadora Técnica (29 cálculos)
                    </span>
                    <input type="text" class="form-control" id="searchCalc" placeholder="Buscar cálculo...">
                </div>
            </div>
        </div>
    </div>

    <!-- Ícones de cálculos -->
    <div class="calculation-icons">
        <div class="calc-icon" data-calc="producao_final">
            <i class="fas fa-industry"></i> Produção Final
        </div>
        <div class="calc-icon" data-calc="producao_litro">
            <i class="fas fa-tint"></i> Produção (Litro)
        </div>
        <div class="calc-icon" data-calc="abaixar_brix">
            <i class="fas fa-water"></i> Abaixar Brix
        </div>
        <div class="calc-icon" data-calc="brix_corrigido">
            <i class="fas fa-thermometer-half"></i> Brix Corrigido
        </div>
        <div class="calc-icon" data-calc="peso_bruto">
            <i class="fas fa-weight-hanging"></i> Peso Bruto
        </div>
        <div class="calc-icon" data-calc="corantes">
            <i class="fas fa-fill-drip"></i> Corantes
        </div>
        <div class="calc-icon" data-calc="densidade">
            <i class="fas fa-vial"></i> Densidade
        </div>
        <div class="calc-icon" data-calc="ratio">
            <i class="fas fa-balance-scale"></i> Ratio
        </div>
        <div class="calc-icon" data-calc="ratio_brix">
            <i class="fas fa-calculator"></i> Ratio - Brix
        </div>
        <div class="calc-icon" data-calc="ratio_acidez">
            <i class="fas fa-flask"></i> Ratio - Acidez
        </div>
        <div class="calc-icon" data-calc="acidez">
            <i class="fas fa-burn"></i> Acidez (%)
        </div>
        <div class="calc-icon" data-calc="soda">
            <i class="fas fa-prescription-bottle"></i> Cálculo de Soda
        </div>
        <div class="calc-icon" data-calc="vitamina_c">
            <i class="fas fa-tablets"></i> Vitamina C
        </div>
        <div class="calc-icon" data-calc="soda_diversey">
            <i class="fas fa-prescription-bottle-alt"></i> Soda-Diversey
        </div>
        <div class="calc-icon" data-calc="acido_diversey">
            <i class="fas fa-vial"></i> Ácido-Diversey
        </div>
        <div class="calc-icon" data-calc="perda_base">
            <i class="fas fa-percent"></i> Perda de Base
        </div>
        <div class="calc-icon" data-calc="acucar_puxar">
            <i class="fas fa-cubes"></i> Açúcar a Puxar
        </div>
        <div class="calc-icon" data-calc="acucar_batido">
            <i class="fas fa-candy-cane"></i> Açúcar Batido
        </div>
        <div class="calc-icon" data-calc="previsao_brix">
            <i class="fas fa-chart-line"></i> Previsão Brix
        </div>
        <div class="calc-icon" data-calc="previsao_acidez">
            <i class="fas fa-chart-bar"></i> Previsão Acidez
        </div>
        <div class="calc-icon active" data-calc="tempo_finalizacao">
            <i class="fas fa-clock"></i> Tempo Finalização
        </div>
        <div class="calc-icon" data-calc="aumentar_acidez">
            <i class="fas fa-arrow-up"></i> Aumentar Acidez
        </div>
        <div class="calc-icon" data-calc="diminuir_acidez">
            <i class="fas fa-arrow-down"></i> Diminuir Acidez
        </div>
        <div class="calc-icon" data-calc="correcao_brix">
            <i class="fas fa-prescription"></i> Correção de Brix
        </div>
        <div class="calc-icon" data-calc="cristal_liquido">
            <i class="fas fa-exchange-alt"></i> Cristal → Líquido
        </div>
        <div class="calc-icon" data-calc="correcao_acucar">
            <i class="fas fa-edit"></i> Correção Açúcar
        </div>
        <div class="calc-icon" data-calc="liquido_cristal">
            <i class="fas fa-exchange-alt"></i> Líquido → Cristal
        </div>
        <div class="calc-icon" data-calc="peso_liquido_200">
            <i class="fas fa-weight"></i> Peso Líquido 200
        </div>
        <div class="calc-icon" data-calc="peso_liquido_litro">
            <i class="fas fa-fill"></i> Peso Líquido Litro
        </div>
    </div>

    <!-- Container da Calculadora -->
    <div id="calculatorContainer" class="card">
        <div class="card-body">
            <div class="calculator-header" id="calculatorTitle">
                <i class="fas fa-clock"></i> Tempo Finalização (TQ)
            </div>
            
            <div class="calculator-description mb-3">
                Calcula o tempo estimado para finalizar o TQ com base na capacidade total, volume atual e linha utilizada.
            </div>
            
            <div class="formula-box">
                <div class="formula-title">Fórmula:</div>
                <div>Tempo = (TQ Total - TQ Atual) ÷ Vazão da Linha</div>
            </div>
            
            <form id="formTempoFinalizacao">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Capacidade Total do TQ:</label>
                            <div class="input-with-unit">
                                <input type="number" class="form-control" name="tq_total" step="1" required>
                                <span class="input-unit">L</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Volume Atual no TQ:</label>
                            <div class="input-with-unit">
                                <input type="number" class="form-control" name="tq_atual" step="1" required>
                                <span class="input-unit">L</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Linha Utilizada:</label>
                            <select class="form-select" name="linha">
                                <option value="1000ml">1000ml (200 L/min)</option>
                                <option value="200ml">200ml (80 L/min)</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Hora Atual:</label>
                            <input type="time" class="form-control" name="hora_atual" required>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12 text-end">
                        <button type="button" class="btn btn-light me-2" id="btnLimpar">Limpar</button>
                        <button type="button" class="btn btn-calculate" id="btnCalcular">
                            <span class="loader"></span> Calcular
                        </button>
                    </div>
                </div>
            </form>
            
            <div class="result-box mt-4" id="resultadoCalculo" style="display:none;">
                <!-- Resultados especiais para o cálculo de Tempo de Finalização (TQ) -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="result-item">
                            <div class="result-label">Tempo Restante:</div>
                            <div class="result-value" id="tempoRestante">-</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Horário de Finalização:</div>
                            <div class="result-value" id="horaFinalizacao">-</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Horário de Metade do TQ:</div>
                            <div class="result-value" id="horaMetade">-</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Vazão Utilizada:</div>
                            <div class="result-value" id="vazaoUtilizada">-</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <!-- Indicador visual -->
                        <div class="mt-2 mb-3">
                            <div class="progress" style="height: 30px;">
                                <div class="progress-bar bg-success" id="tqProgress" role="progressbar" 
                                    style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small>0L</small>
                                <small>50%</small>
                                <small id="tqTotalValue">0L</small>
                            </div>
                        </div>
                        
                        <!-- Relógio digital -->
                        <div class="mt-3 d-flex justify-content-center align-items-center">
                            <div class="text-center">
                                <i class="fas fa-clock fa-2x mb-2 text-primary"></i>
                                <div class="h4" id="currentTime">--:--</div>
                                <div class="small text-muted">Hora Atual</div>
                            </div>
                            <div class="mx-4">→</div>
                            <div class="text-center">
                                <i class="fas fa-flag-checkered fa-2x mb-2 text-success"></i>
                                <div class="h4" id="finishTime">--:--</div>
                                <div class="small text-muted">Hora Finalização</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Dica:</strong> Busque o cálculo desejado utilizando a barra de pesquisa no topo ou clique nos ícones dos cálculos.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Preenche o campo de hora atual com a hora do sistema
    const horaAtualInput = document.querySelector('input[name="hora_atual"]');
    if (horaAtualInput) {
        const agora = new Date();
        const horaFormatada = agora.getHours().toString().padStart(2, '0') + ':' + 
                             agora.getMinutes().toString().padStart(2, '0');
        horaAtualInput.value = horaFormatada;
    }
    
    // Filtro de pesquisa para ícones de cálculo
    const searchInput = document.getElementById('searchCalc');
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        
        document.querySelectorAll('.calc-icon').forEach(icon => {
            const text = icon.textContent.toLowerCase();
            const shouldShow = text.includes(searchTerm);
            
            icon.style.display = shouldShow ? '' : 'none';
        });
    });
    
    // Clique nos ícones de cálculo
    document.querySelectorAll('.calc-icon').forEach(icon => {
        icon.addEventListener('click', function() {
            // Remover classe ativa de todos os ícones
            document.querySelectorAll('.calc-icon').forEach(i => i.classList.remove('active'));
            // Adicionar classe ativa ao ícone clicado
            this.classList.add('active');
            
            // Aqui você poderia carregar o cálculo específico
            const calcId = this.getAttribute('data-calc');
            document.getElementById('calculatorTitle').innerHTML = `<i class="${this.querySelector('i').className}"></i> ${this.textContent.trim()}`;
            
            // Esta é uma simulação - em um cenário real, você carregaria o conteúdo específico
            if (calcId === 'tempo_finalizacao') {
                // Não fazer nada, já estamos na página correta
            } else {
                // Simulação: mostrar mensagem ou redirecionamento
                alert(`Em uma implementação completa, carregaria o cálculo: ${this.textContent.trim()}`);
            }
        });
    });
    
    // Botão de limpar
    document.getElementById('btnLimpar').addEventListener('click', function() {
        document.getElementById('formTempoFinalizacao').reset();
        document.getElementById('resultadoCalculo').style.display = 'none';
        
        // Preencher novamente o campo de hora atual
        if (horaAtualInput) {
            const agora = new Date();
            const horaFormatada = agora.getHours().toString().padStart(2, '0') + ':' + 
                                agora.getMinutes().toString().padStart(2, '0');
            horaAtualInput.value = horaFormatada;
        }
    });
    
    // Botão de calcular
    document.getElementById('btnCalcular').addEventListener('click', function() {
        calcularTempoFinalizacao();
    });
    
    // Função para calcular o tempo de finalização
    function calcularTempoFinalizacao() {
        const form = document.getElementById('formTempoFinalizacao');
        
        // Obter valores do formulário
        const tqTotal = parseFloat(form.querySelector('input[name="tq_total"]').value) || 0;
        const tqAtual = parseFloat(form.querySelector('input[name="tq_atual"]').value) || 0;
        const linha = form.querySelector('select[name="linha"]').value;
        const horaAtualInput = form.querySelector('input[name="hora_atual"]').value || '';
        
        // Validar os dados
        if (tqTotal <= 0 || tqAtual < 0) {
            alert('Por favor, informe valores válidos para capacidade total e volume atual.');
            return;
        }
        
        if (tqAtual > tqTotal) {
            alert('O volume atual não pode ser maior que a capacidade total do TQ.');
            return;
        }
        
        // Definir a vazão com base na linha selecionada
        let vazao = 0;
        if (linha === '1000ml') {
            vazao = 200; // 200 L/min para linha 1000ml
        } else if (linha === '200ml') {
            vazao = 80;  // 80 L/min para linha 200ml
        }
        
        // Calcular volume restante
        const volumeRestante = tqTotal - tqAtual;
        
        // Calcular tempo para finalizar em minutos
        const tempoFinalMinutos = volumeRestante / vazao;
        
        // Calcular o tempo até a metade do TQ
        const meioTqLitros = tqTotal / 2;
        const volumeAteMeio = Math.max(0, meioTqLitros - tqAtual);
        const tempoMeioMinutos = volumeAteMeio / vazao;
        
        // Calcular o percentual atual do TQ
        const percentualAtual = (tqAtual / tqTotal) * 100;
        
        // Formatar o tempo restante
        const tempoHoras = Math.floor(tempoFinalMinutos / 60);
        const tempoMinutos = Math.floor(tempoFinalMinutos % 60);
        const tempoSegundos = Math.floor((tempoFinalMinutos % 1) * 60);
        const tempoFormatado = `${tempoHoras > 0 ? tempoHoras + 'h ' : ''}${tempoMinutos}min ${tempoSegundos}s`;
        
        // Obter hora atual a partir do input ou usar a hora atual do sistema
        let horaAtual;
        if (horaAtualInput) {
            const [horas, minutos] = horaAtualInput.split(':').map(Number);
            horaAtual = new Date();
            horaAtual.setHours(horas, minutos, 0);
        } else {
            horaAtual = new Date();
        }
        
        // Calcular hora de finalização
        const horaFinalizacao = new Date(horaAtual.getTime() + tempoFinalMinutos * 60000);
        const horaFinalizacaoFormatada = `${horaFinalizacao.getHours().toString().padStart(2, '0')}:${horaFinalizacao.getMinutes().toString().padStart(2, '0')}`;
        
        // Calcular hora de metade
        const horaMeio = new Date(horaAtual.getTime() + tempoMeioMinutos * 60000);
        const horaMeioFormatada = volumeAteMeio > 0 ? 
            `${horaMeio.getHours().toString().padStart(2, '0')}:${horaMeio.getMinutes().toString().padStart(2, '0')}` : 
            'Já passou da metade';
        
        // Exibir os resultados no HTML
        document.getElementById('tempoRestante').textContent = tempoFormatado;
        document.getElementById('horaFinalizacao').textContent = horaFinalizacaoFormatada;
        document.getElementById('horaMetade').textContent = horaMeioFormatada;
        document.getElementById('vazaoUtilizada').textContent = vazao + ' L/min';
        
        // Atualizar a barra de progresso
        const progressBar = document.getElementById('tqProgress');
        progressBar.style.width = percentualAtual + '%';
        progressBar.textContent = percentualAtual.toFixed(1) + '%';
        progressBar.setAttribute('aria-valuenow', percentualAtual);
        
        // Atualizar o relógio digital
        document.getElementById('currentTime').textContent = 
            `${horaAtual.getHours().toString().padStart(2, '0')}:${horaAtual.getMinutes().toString().padStart(2, '0')}`;
        document.getElementById('finishTime').textContent = horaFinalizacaoFormatada;
        
        // Atualizar o valor total do TQ na escala
        document.getElementById('tqTotalValue').textContent = tqTotal + 'L';
        
        // Mostrar a caixa de resultado
        document.getElementById('resultadoCalculo').style.display = 'block';
    }
});
</script>
{% endblock %}